# 事件总线与版本变更

- 适用版本：SiYuan `v3.5.7` / `petal v1.1.8`
- 最后核对：2026-02-21
- 稳定性：stable（含部分历史事件）
- 权威来源：
  - <https://github.com/siyuan-note/petal/blob/main/siyuan.d.ts>
  - <https://github.com/siyuan-note/petal/blob/main/CHANGELOG.md>

## 1. 常用事件

- 编辑器相关：
  - `loaded-protyle-dynamic`
  - `loaded-protyle-static`
  - `switch-protyle`
  - `switch-protyle-mode`
  - `destroy-protyle`
- 菜单相关：
  - `click-blockicon`
  - `click-editortitleicon`
  - `open-menu-content`
  - `open-menu-doctree`
- 同步与系统：
  - `sync-start` / `sync-end` / `sync-fail`
  - `lock-screen`
- 代码块语言（新增）：
  - `code-language-update`
  - `code-language-change`

## 2. 已移除/替代事件

- `loaded-protyle`：历史事件，已由 `loaded-protyle-static` 等替代

## 3. 监听最佳实践

1. 所有 `on` 必须在 `onunload` 对应 `off`
2. 回调函数使用类字段，避免匿名函数无法解绑
3. 只监听必要事件，避免高频事件造成性能开销

## 4. 事件监听模板

```ts
private readonly onCodeLang = (e: CustomEvent<any>) => {
  console.log(e.detail.language);
};

onload() {
  this.eventBus.on("code-language-change", this.onCodeLang);
}

onunload() {
  this.eventBus.off("code-language-change", this.onCodeLang);
}
```

## 5. 版本对齐建议

- 升级思源后，先对照 `petal/CHANGELOG.md` 查看新增或变更事件
- 插件中对非核心事件加“存在性降级”逻辑
- 事件参数以 `siyuan.d.ts` 中 `IEventBusMap` 为准

## 6. 本章如何使用

- 设计功能交互前先选事件，再写 UI 逻辑
- 出现“事件不触发”时先检查版本与事件名
- 迁移老插件时优先替换已废弃事件

