# 插件类与生命周期

- 适用版本：SiYuan `v3.5.7` / `petal v1.1.8`
- 最后核对：2026-02-21
- 稳定性：stable
- 权威来源：
  - <https://github.com/siyuan-note/petal/blob/main/siyuan.d.ts>
  - <https://github.com/siyuan-note/petal/blob/main/CHANGELOG.md>

## 1. Plugin 核心生命周期

`Plugin` 常用生命周期：

- `onload()`：插件初始化入口
- `onDataChanged()`：插件数据变更时触发
- `onLayoutReady()`：界面布局就绪后触发
- `onunload()`：插件卸载/禁用时触发
- `uninstall()`：卸载流程钩子

## 2. 常用实例方法

- `addTopBar()`：添加顶栏按钮
- `addStatusBar()`：添加状态栏元素
- `addDock()`：注册侧栏面板
- `addCommand()`：注册命令面板命令
- `loadData()/saveData()/removeData()`：插件数据存储
- `openSetting()`：打开插件设置界面

## 3. 最小生命周期模板

```ts
import { Plugin } from "siyuan";

export default class MyPlugin extends Plugin {
  private onSwitch = (e: CustomEvent<any>) => {
    console.log("switch-protyle", e.detail);
  };

  onload() {
    this.eventBus.on("switch-protyle", this.onSwitch);
  }

  onunload() {
    this.eventBus.off("switch-protyle", this.onSwitch);
  }
}
```

## 4. 生命周期中的常见坑

- 在 `onload()` 里执行过重同步逻辑，会拖慢启动
- 注册事件后未解绑，导致重复触发或内存泄露
- 配置变更后忘记兼容旧存储结构（建议加版本字段）

## 5. 本章如何使用

- 新建插件：直接套第 3 节模板
- 老项目排查：按第 4 节逐项对照
- 扩展能力：搭配 `常用方法速览.md` 与 `事件总线与版本变更.md`

