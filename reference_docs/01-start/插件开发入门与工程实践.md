# 插件开发入门与工程实践

- 适用版本：SiYuan `v3.5.7`
- 官方仓库同步到：`siyuan-note/siyuan@master` + Release `v3.5.7`（2026-02-14）
- 最后核对：2026-02-21
- 稳定性：stable
- 权威来源：
  - <https://github.com/siyuan-note/plugin-sample>
  - <https://github.com/siyuan-note/plugin-sample-vite-svelte>
  - <https://github.com/siyuan-note/plugin-sample-vite-vue>
  - <https://github.com/siyuan-note/siyuan>
  - <https://github.com/siyuan-community/siyuan-developer-docs/tree/main>

## 1. 目标与快速开工

### 1.1 目标

10~20 分钟内完成“能跑、能调试、能发布”的插件骨架。

### 1.2 快速步骤

1. 模板建仓库（仓库名 = 插件名，默认分支 `main`）。
2. 安装依赖并跑开发构建（`pnpm i` + `pnpm dev`）。
3. 在 `src/index.ts` 继承 `Plugin` 实现 `onload()`。
4. 用插件 API 做交互，用内核 API 做数据操作。
5. 构建 `package.zip` 并发布 GitHub Release。

## 2. 开发前置

- 语言：JavaScript（必需），TypeScript（强烈建议）
- 环境：Node.js + pnpm
- 编辑器：VS Code
- 建议：单独使用一个思源工作空间做开发，避免误伤主数据

## 3. 模板选择

### 官方模板（稳定）

- 仓库：`siyuan-note/plugin-sample`
- 适合：纯插件 API 开发、较少前端框架依赖

### Vite 模板（更高开发效率）

- Svelte：`plugin-sample-vite-svelte`
- Vue：`plugin-sample-vite-vue`
- 适合：需要热更新、现代构建与组件化界面

## 4. 初始化流程

1. 使用模板创建仓库（仓库名必须与插件名一致，默认分支 `main`）。
2. 克隆到本地，安装依赖：`pnpm i`。
3. 运行开发构建：
   - 官方模板常用：`pnpm run dev`
   - Vite 模板常用：`pnpm dev`
4. 在思源集市“已下载”中启用插件。

## 5. 最小插件骨架

```ts
import { Plugin } from "siyuan";

export default class MyPlugin extends Plugin {
  onload() {
    this.addTopBar({
      icon: "iconInfo",
      title: "My Plugin",
      callback: () => {
        console.log("plugin loaded");
      },
    });
  }

  onunload() {
    // 在这里做解绑和清理
  }
}
```

## 6. 高频 API 与迁移重点

### 6.1 最常用 API

- 插件 API：`fetchSyncPost`、`openTab`、`showMessage`、`confirm`
- 内核 API：`/api/block/*`、`/api/attr/*`、`/api/query/sql`、`/api/av/*`

### 6.2 迁移重点（2026H1）

- `/api/system/reloadUI` -> `/api/ui/reloadUI`
- `/api/storage/setLocalStorage` -> `/api/storage/setLocalStorageVal`
- `batchSetAttributeViewBlockAttrs.values[*].rowID` -> `itemID`（2026-06-30 后）
- 统一迁移证据与替代路径：`reference/03-kernel-api/弃用接口迁移清单-2026H1.md`

## 7. plugin.json 关键字段

- `name`：必须与仓库名一致，且全局唯一
- `version`：语义化版本（必须随发布递增）
- `minAppVersion`：最低支持思源版本
- `backends` / `frontends`：平台约束
- `displayName` / `description` / `readme`：集市展示元信息

## 8. 打包与上架

1. 执行 `pnpm run build` 生成 `package.zip`
2. 创建 GitHub Release（Tag 建议与 `version` 保持一致）
3. 上传 `package.zip` 到 Release 附件
4. 首次发布需向 `siyuan-note/bazaar` 提交 `plugins.json` 仓库索引 PR

## 9. 发版前 Checklist

- `plugin.json.version` 已更新
- `minAppVersion` 合理
- `package.zip` 文件完整
- Release 附件上传正确

## 10. 开发要点（完整版）

### 10.1 两层 API

- 插件 API：生命周期、事件总线、UI 组件与插件本地数据。
- 内核 API：文档、块、属性、SQL、文件、数据库（AV）等数据能力。

### 10.2 工程主线

- 模板初始化 -> 本地调试 -> 接口开发 -> 迁移兼容 -> 打包上架。

### 10.3 风险控制

- 非公开 API 不保证兼容，必须做 fallback。
- 版本敏感项集中在 `router.go` 与 issue comment。
- 数据库 AV 参数迁移（`rowID -> itemID`）需要提前改造。

## 11. 工程实践建议

- 不要直接用 `fs` 读写工作空间 `data/`，优先调用 `/api/file/*`
- 事件监听必须成对注册/解绑（`on` + `off`）
- 把请求封装成统一函数，处理 `code/msg` 与超时
- 每次发布前检查 `version`、`minAppVersion`、`package.zip` 内容

## 12. 文档查阅方式

### 12.1 按任务查阅

- 新建项目：`01-start`
- 插件交互：`02-plugin-api`
- 调内核 API：`03-kernel-api`
- 数据库功能：`04-database-av`
- 数据模型：`05-block-model`
- 发布维护：`06-guides`

### 12.2 按问题查阅

- 事件不触发：`02-plugin-api/事件总线与版本变更.md`
- 接口升级后失效：`03-kernel-api/弃用接口迁移清单-2026H1.md`
- AV 行 ID 混乱：`04-database-av/rowID到itemID迁移指南.md`
- 集市不更新：`06-guides/调试与发布流程.md`

### 12.3 主文档与附录配合

- 先读主文档（`01`~`06`）确定实现路径。
- 再查附录（`07-official-index`）做全量接口核对。
- 若主文档与附录冲突，以附录中的官方来源链接为准并回写主文档。

## 13. 文档维护方式

每次大版本升级后优先核对：

1. `API_zh_CN.md`
2. `kernel/api/router.go`
3. `petal/siyuan.d.ts` 和 `petal/CHANGELOG.md`

若发现迁移项，优先更新：

- `03-kernel-api/弃用接口迁移清单-2026H1.md`
- `04-database-av/rowID到itemID迁移指南.md`
- `07-official-index/官方API全量索引-按模块.md`
- `07-official-index/router路由变更与风险索引.md`
